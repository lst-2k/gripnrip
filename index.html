<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LST-74 Grip&Rip Divisional Season</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
 <style>
    :root { 
        --div1: #0047AB; --div2: #008B8B; --div3: #D2691E; --gold: #FFD700; 
        --header-grad: linear-gradient(135deg, #7C7C7C 0%, #545454 100%); 
        --info-grad: linear-gradient(135deg, #7C7C7C 0%, #545454 100%);
    }
    body { background-color: #f0f2f5; margin: 10px; font-family: 'Segoe UI', sans-serif; font-size: 15px; overflow-x: hidden; }
    .leaderboard-container { max-width: 1400px; margin: 0 auto 20px auto; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
    .header { background: var(--header-grad); color: white; padding: 15px; text-align: center; border-bottom: 4px solid var(--gold); }
    .header-title { font-size: 20px; font-weight: 900; text-transform: uppercase; letter-spacing: 1px; text-shadow: 2px 2px 4px rgba(0,0,0,0.5); }
    
    .info-bar { display: flex; justify-content: center; gap: 15px; background: var(--info-grad); color: #fff; padding: 10px; border-bottom: 1px solid #444; font-size: 13px; }
    .editable-label { color: var(--gold); font-weight: 800; margin-right: 5px; text-transform: uppercase; }
    
    .div-header { color: white; padding: 10px; font-size: 18px; font-weight: bold; text-transform: uppercase; text-align: center; }
    .div-1 { background: var(--div1); } .div-2 { background: var(--div2); } .div-3 { background: var(--div3); } 
    
    .table-wrapper { width: 100%; overflow-x: auto; }
    /* Reduced min-width and used fixed layout to bring columns together */
    table { width: 100%; border-collapse: collapse; min-width: 800px; table-layout: fixed; } 
    
    thead th { background: #f4f4f4; font-size: 10px; padding: 8px 2px; text-transform: uppercase; border-bottom: 2px solid #ddd; }
    td { padding: 8px 4px; text-align: center; border-bottom: 1px solid #eee; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    
    .name-col-cell { display: flex; align-items: center; gap: 8px; text-align: left; padding-left: 5px; }
    .pts-col { font-weight: 900; color: #333; background: #fafafa; }
    .season-header { background: #7C7C7C; color: white; padding: 12px; font-size: 20px; font-weight: 900; text-align: center; text-transform: uppercase; border-bottom: 2px solid var(--gold); }
    .hidden { display: none !important; }
	
	/* Center the standings container and limit overall width */
#season-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 20px;
    padding: 20px;
}

/* The outer box for each division */
.standings-box {
    width: 100%;
    max-width: 420px; /* Reduced max-width to keep columns tight */
    background: white;
    border-radius: 8px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.05);
    overflow: hidden;
}

/* Tighten the Name column so it doesn't create a massive gap */
.standings-name-col {
    text-align: left;
    padding-left: 10px !important;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    /* We don't set a fixed width here so it can handle different name lengths, 
       but the table-layout and other fixed columns will keep it contained */
}

.standings-box td, .standings-box th {
    padding: 6px 4px;
    font-size: 13px;
}
</style>
</head>
<body>
    <div id="main-container" class="leaderboard-container">
        <div class="header"><div class="header-title">LST-74 Grip&Rip Divisional Season</div></div>
        <div class="info-bar">
            <div class="info-item"><span class="editable-label">Venue:</span><span id="course-venue">...</span></div>
            <div class="info-item"><span class="editable-label">Par:</span><span id="course-par">--</span></div>
        </div>
        <div id="div-container"></div>
    </div>
    <div class="leaderboard-container">
        <div class="season-header">Season Standings</div>
        <div id="season-container"></div>
    </div>
    <script>
        const ptsMap = [100, 90, 80, 70, 60, 50, 40, 30, 20, 10];
        let state = { players: [], showR3R4: false, par: 72, venue: '' };

        async function loadData() {
            try {
                const response = await fetch('data.json?t=' + Date.now());
                state = await response.json();
                render();
            } catch (e) { 
                document.getElementById('div-container').innerHTML = "<div style='padding:40px; text-align:center;'>Waiting for tournament data...</div>"; 
            }
        }

        function getScore(p) {
            let t = (Number(p.r1)||0) + (Number(p.r2)||0);
            if(state.showR3R4) t += (Number(p.r3)||0) + (Number(p.r4)||0);
            return t;
        }

        function countRounds(p) {
            let c = 0; if (Number(p.r1) > 0) c++; if (Number(p.r2) > 0) c++;
            if (state.showR3R4) { if (Number(p.r3) > 0) c++; if (Number(p.r4) > 0) c++; }
            return c;
        }

        const getPlatIcon = (p) => {
            if (p === 'xbox') return '<i class="fa-brands fa-xbox" style="color:#107C10"></i>';
            if (p === 'playstation') return '<i class="fa-brands fa-playstation" style="color:#003087"></i>';
            return '<i class="fa-brands fa-steam"></i>';
        };

function render() {
    document.getElementById('course-venue').innerText = state.venue;
    document.getElementById('course-par').innerText = state.par;
    const container = document.getElementById('div-container');
    container.innerHTML = '';

    [1, 2, 3].forEach(divNum => {
        let dps = state.players.filter(p => String(p.division) === String(divNum));
        
        // Sort by rounds completed first, then by score
        dps.sort((a,b) => (countRounds(b) - countRounds(a)) || (getScore(a) - getScore(b)));

        // Calculate bonuses for the division
        const minPutt = Math.min(...dps.filter(p => parseFloat(p.putt) > 0).map(p => parseFloat(p.putt)));
        const maxHole = Math.max(...dps.map(p => parseFloat(p.hole) || 0));

        const divBox = document.createElement('div');
        divBox.innerHTML = `
        <div class="div-header div-${divNum}">Division ${divNum}</div>
        <div class="table-wrapper">
            <table>
                <thead><tr>
                    <th style="width:40px">POS</th>
                    <th style="text-align:left; padding-left:15px; width:160px;">PLAYER</th>
                    <th style="width:45px">PAR</th>
                    <th style="width:40px">R1</th>
                    <th style="width:40px">R2</th>
                    <th style="width:40px" class="${state.showR3R4 ? '' : 'hidden'}">R3</th>
                    <th style="width:40px" class="${state.showR3R4 ? '' : 'hidden'}">R4</th>
                    <th style="width:55px">TOTAL</th>
                    <th style="width:70px">L-PUTT</th>
                    <th style="width:70px">L-HOLE</th>
                    <th style="width:65px">HIO</th>
                    <th style="width:65px">ALBA</th>
                    <th class="pts-col" style="width:50px">PTS</th>
                </tr></thead>
                <tbody>${dps.map((p, idx) => {
                    const score = getScore(p); 
                    const rds = countRounds(p); 
                    const toPar = score - (state.par * rds);
                    const parText = rds === 0 ? '-' : (toPar === 0 ? 'E' : (toPar > 0 ? '+' + toPar : toPar));
                    
                    // TIE-AWARE POINT LOGIC
                    // Find the first occurrence of this score to award same points
                    const firstTieIdx = dps.findIndex(x => getScore(x) === score && countRounds(x) === rds);
                    const tieCount = dps.filter(x => getScore(x) === score && countRounds(x) === rds).length;
                    const displayRank = (rds > 0) ? (tieCount > 1 ? 'T' + (firstTieIdx + 1) : (idx + 1)) : '-';

                    let wkPts = 0;
                    if (rds >= (state.showR3R4 ? 4 : 2)) {
                        // Everyone tied at this position gets the same base points
                        wkPts = ptsMap[firstTieIdx] || 5;
                        
                        // Individual bonuses
                        if (parseFloat(p.putt) === minPutt && minPutt > 0) wkPts += 25;
                        if (parseFloat(p.hole) === maxHole && maxHole > 0) wkPts += 25;
                        wkPts += (Number(p.hio) || 0);
                        wkPts += (Number(p.albatross) || 0);
                    }
                    
                    p.liveWkPts = wkPts; // Temp store for the season standings below

                    return `<tr>
                        <td>${displayRank}</td>
                        <td><div class="name-col-cell"><span>${getPlatIcon(p.platform)}</span><span>${p.name}</span></div></td>
                        <td style="font-weight:bold; color:${toPar < 0 ? 'red' : 'black'}">${parText}</td>
                        <td>${p.r1 || '-'}</td>
                        <td>${p.r2 || '-'}</td>
                        <td class="${state.showR3R4 ? '' : 'hidden'}">${p.r3 || '-'}</td>
                        <td class="${state.showR3R4 ? '' : 'hidden'}">${p.r4 || '-'}</td>
                        <td style="font-weight:bold">${score > 0 ? score : '-'}</td>
                        <td>${p.putt ? p.putt + 'ft' : '-'}</td>
                        <td>${p.hole ? p.hole + 'yd' : '-'}</td>
                        <td style="background: rgba(212, 175, 55, 0.05); font-weight:bold; color:${p.hio > 0 ? '#b8860b' : '#ccc'}">${p.hio || '-'}</td>
                        <td style="background: rgba(212, 175, 55, 0.05); font-weight:bold; color:${p.albatross > 0 ? '#b8860b' : '#ccc'}">${p.albatross || '-'}</td>
                        <td class="pts-col">${wkPts > 0 ? wkPts : '-'}</td>
                    </tr>`;
                }).join('')}</tbody>
            </table>
        </div>`;
        container.appendChild(divBox);
    });

    renderSeason();
}

function renderSeason() {
    const container = document.getElementById('season-container');
    container.innerHTML = ''; 

    [1, 2, 3].forEach(divNum => {
        let dps = state.players.filter(p => String(p.division) === String(divNum));
        
        // Sort by total points (Season Points + Live Weekly Points)
        dps.sort((a,b) => ((b.seasonPts || 0) + (b.liveWkPts || 0)) - ((a.seasonPts || 0) + (a.liveWkPts || 0)));
        
        if (dps.length === 0) return;

        const divBox = document.createElement('div');
        divBox.className = 'standings-box';

        const rowsHtml = dps.map((p, idx) => {
            const totalPts = (p.seasonPts || 0) + (p.liveWkPts || 0);
            
            // ACC: Shows historical season to par
            const accumToPar = p.seasonToPar || 0;
            const parDisplay = accumToPar === 0 ? 'E' : (accumToPar > 0 ? '+' + accumToPar : accumToPar);
            const parColor = accumToPar < 0 ? 'red' : 'black';

            // EV: Historical + 1 if they have a score this week
            const playedThisWeek = countRounds(p) > 0 ? 1 : 0;
            const totalEvents = (p.seasonEvents || 0) + playedThisWeek;

            // TIE Rank Logic
            const firstTieIdx = dps.findIndex(x => ((x.seasonPts || 0) + (x.liveWkPts || 0)) === totalPts);
            const tieCount = dps.filter(x => ((x.seasonPts || 0) + (x.liveWkPts || 0)) === totalPts).length;
            const displayRank = tieCount > 1 ? 'T' + (firstTieIdx + 1) : (idx + 1);

            let changeIcon = (p.prevRank) ? (idx + 1 < p.prevRank ? '▲' : (idx + 1 > p.prevRank ? '▼' : '—')) : '—';
            
 return `<tr>
                <td style="width:30px">${changeIcon}</td>
                <td style="width:35px">${displayRank}</td>
                <td class="standings-name-col">
                    <div class="name-col-cell">
                        <span>${getPlatIcon(p.platform)}</span>${p.name}
                    </div>
                </td>
                <td style="width:40px; font-weight:bold; color:${parColor}">${parDisplay}</td>
                <td style="width:30px">${totalEvents}</td>
                <td style="width:45px" class="pts-col">${totalPts}</td>
            </tr>`;
        }).join('');
        
divBox.innerHTML = `
            <div class="div-header div-${divNum}" style="font-size:14px; padding:8px;">Division ${divNum} Standings</div>
            <div class="table-wrapper">
                <table style="table-layout: fixed; width: 100%;">
                    <thead>
                        <tr>
                            <th style="width:30px">+/-</th>
                            <th style="width:35px">RNK</th>
                            <th style="text-align:left; padding-left:10px;">PLAYER</th> <th style="width:40px">ACC</th>
                            <th style="width:30px">EV</th>
                            <th style="width:45px" class="pts-col">PTS</th>
                        </tr>
                    </thead>
                    <tbody>${rowsHtml}</tbody>
                </table>
            </div>`;
        
        container.appendChild(divBox);
    });
}

        loadData();
        setInterval(loadData, 30000);
    </script>
</body>
</html>