<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LST74 Grip & Rip Divisional Live Leaderboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root { 
            --div1: #0047AB; --div2: #008B8B; --div3: #D2691E; --gold: #FFD700; 
            --header-grad: linear-gradient(135deg, #2c2c2c 0%, #000000 100%); 
            --info-grad: linear-gradient(135deg, #4a4a4a 0%, #2d2d2d 100%);
            --red: #dc3545; --green: #28a745;
            --promo-bg: rgba(40, 167, 69, 0.12);
            --releg-bg: rgba(220, 53, 69, 0.12);
        }
        body { background-color: #f0f2f5; margin: 10px; font-family: 'Segoe UI', sans-serif; font-size: 16px; }
        .leaderboard-container { max-width: 1400px; margin: 0 auto 30px auto; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.15); }
        
        /* Header & Logo Styling */
        .header { background: var(--header-grad); color: white; padding: 20px; text-align: center; border-bottom: 4px solid var(--gold); }
        .logo-img { max-width: 280px; height: auto; margin-bottom: 10px; filter: drop-shadow(0 4px 8px rgba(0,0,0,0.5)); }
        
        .table-scroll-area { width: 100%; overflow-x: auto; -webkit-overflow-scrolling: touch; position: relative; }
        .info-bar { background: var(--info-grad); color: #fff; padding: 15px; display: flex; justify-content: center; gap: 15px; flex-wrap: wrap; border-bottom: 3px solid var(--gold); }
        .info-item { background: rgba(255,255,255,0.1); padding: 5px 12px; border-radius: 6px; font-size: 14px; }
        .label { color: var(--gold); font-weight: 900; margin-right: 8px; text-transform: uppercase; }
        
        .div-header { color: white; padding: 12px 20px; font-size: 20px; font-weight: bold; text-transform: uppercase; position: sticky; left: 0; }
        .div-1 { background: var(--div1); } .div-2 { background: var(--div2); } .div-3 { background: var(--div3); } 
        
        table { width: 100%; border-collapse: collapse; min-width: 900px; }
        thead th { background: #f4f4f4; font-size: 11px; padding: 12px; border-bottom: 2px solid #ddd; color: #444; text-transform: uppercase; }
        td { padding: 12px; text-align: center; border-bottom: 1px solid #eee; font-size: 17px; font-weight: 700; white-space: nowrap; }
        
        .promo-row { background-color: var(--promo-bg); }
        .releg-row { background-color: var(--releg-bg); }
        .name-cell { display: flex; align-items: center; text-align: left; padding-left: 10px; min-width: 180px; }
        .plat-icon { margin-right: 12px; width: 20px; text-align: center; font-size: 18px; }
        .pts-col { font-weight: 900; color: #0047AB; font-size: 19px; }

        .footer-awards { 
            background: #f9f9f9; font-weight: bold; border-top: 2px solid #ddd; padding: 12px; text-align: center; 
            position: sticky; left: 0; width: 100%; box-sizing: border-box; 
        }
        .award-line { display: block; margin: 3px 0; font-size: 16px; }
        #error-msg { color: white; background: #cc0000; text-align: center; padding: 10px; display: none; font-weight: bold; }
    </style>
</head>
<body>

    <div id="error-msg">‚ö†Ô∏è Update Required: GR_Backup.json not found.</div>

    <div class="leaderboard-container">
        <div class="header">
            <img src="logo.png" alt="LST74 Grip & Rip Logo" class="logo-img">
        </div>
        <div class="info-bar" id="info-bar"></div>
        <div id="div-container"></div>
    </div>

    <div class="leaderboard-container">
        <div style="background:#333; color:white; padding:15px; font-size:24px; font-weight:900; text-align:center; text-transform: uppercase; border-bottom: 2px solid var(--gold);">Season Standings</div>
        <div id="season-container"></div>
    </div>

<script>
    async function loadData() {
        try {
            const response = await fetch('GR_Backup.json?t=' + Date.now());
            if (!response.ok) throw new Error();
            const state = await response.json();
            render(state);
        } catch (e) { document.getElementById('error-msg').style.display = 'block'; }
    }

    function getNum(v) { 
        if(!v || v==='') return null; 
        const n = (v.toString().toUpperCase()==='E') ? 0 : Number(v);
        return isNaN(n) ? null : n;
    }

    function getScoreStyle(v) {
        const n = getNum(v);
        if (n === null) return 'color: black';
        if (n < 0) return 'color: var(--red)';
        if (n === 0) return 'color: var(--green)';
        return 'color: black';
    }

    function getPlatIcon(p) {
        if (p === 'xbox') return '<i class="fa-brands fa-xbox" style="color:#107C10"></i>';
        if (p === 'playstation') return '<i class="fa-brands fa-playstation" style="color:#003087"></i>';
        return '<i class="fa-brands fa-steam" style="color:#171a21"></i>';
    }

    function calculateLivePoints(p, dps, isSig) {
        const score = getNum(p.toPar); if(score === null) return 0;
        const ptsMap = [100, 90, 80, 70, 60, 50, 40, 30, 20, 10];
        const multiplier = isSig ? 2 : 1;
        const sorted = dps.filter(x => getNum(x.toPar) !== null).sort((a,b) => getNum(a.toPar) - getNum(b.toPar));
        const rank = sorted.findIndex(x => getNum(x.toPar) === score);
        let base = (rank !== -1 && rank < 10) ? ptsMap[rank] : 5;
        const validPutts = dps.map(x => getNum(x.putt)).filter(v => v !== null && v > 0);
        const maxP = validPutts.length ? Math.max(...validPutts) : 0;
        const validHoles = dps.map(x => getNum(x.hole)).filter(v => v !== null && v > 0);
        const maxH = validHoles.length ? Math.max(...validHoles) : 0;
        let bonus = 0;
        if(getNum(p.putt) === maxP && maxP > 0) bonus += 25;
        if(getNum(p.hole) === maxH && maxH > 0) bonus += 25;
        return (base + bonus) * multiplier;
    }

    function render(state) {
        document.getElementById('info-bar').innerHTML = `
            <div class="info-item"><span class="label">Season</span><span class="val">${state.season || '1'}</span></div>
            <div class="info-item"><span class="label">Week</span><span class="val">${state.week || '1'}</span></div>
            <div class="info-item"><span class="label">Venue</span><span class="val">${state.venue || 'TBD'}</span></div>
            ${state.isSignature ? '<div class="info-item" style="background:var(--gold); color:black; font-weight:900;">SIGNATURE EVENT (2X)</div>' : ''}
        `;

        const container = document.getElementById('div-container');
        container.innerHTML = '';
        [1, 2, 3].forEach(divNum => {
            let dps = state.players.filter(p => String(p.division) === String(divNum));
            dps.sort((a,b) => (getNum(a.toPar) ?? 999) - (getNum(b.toPar) ?? 999));

            const vP = dps.map(p => ({name: p.name, val: getNum(p.putt)})).filter(v => v.val > 0);
            const bP = vP.length ? vP.reduce((a, b) => (a.val > b.val ? a : b)) : null;
            const vH = dps.map(p => ({name: p.name, val: getNum(p.hole)})).filter(v => v.val > 0);
            const bH = vH.length ? vH.reduce((a, b) => (a.val > b.val ? a : b)) : null;

            container.innerHTML += `
                <div class="table-scroll-area">
                    <div class="div-header div-${divNum}">Division ${divNum} - Live</div>
                    <table>
                        <thead><tr>
                            <th>POS</th>
                            <th style="text-align:left; padding-left:15px;">PLAYER</th>
                            <th>TO PAR</th><th>L-PUTT</th><th>L-SHOT</th><th class="pts-col">LIVE PTS</th>
                        </tr></thead>
                        <tbody>${dps.map((p, i) => `
                            <tr>
                                <td>${getNum(p.toPar)!==null?i+1:'-'}</td>
                                <td><div class="name-cell"><span class="plat-icon">${getPlatIcon(p.platform)}</span>${p.name}</div></td>
                                <td style="${getScoreStyle(p.toPar)}">${p.toPar||'-'}</td>
                                <td>${p.putt||'-'}</td>
                                <td>${p.hole||'-'}</td>
                                <td class="pts-col">${calculateLivePoints(p, dps, state.isSignature)}</td>
                            </tr>
                        `).join('')}</tbody>
                    </table>
                    <div class="footer-awards">
                        <span class="award-line" style="color:var(--div1)">üö© Longest Putt: ${bP ? bP.name+' '+bP.val+'ft' : '---'}</span>
                        <span class="award-line" style="color:var(--div2)">üéØ Longest Hole-out: ${bH ? bH.name+' '+bH.val+'yds' : '---'}</span>
                    </div>
                </div>`;
        });
        renderStandings(state);
    }

    function renderStandings(state) {
        const container = document.getElementById('season-container');
        container.innerHTML = '';
        [1,2,3].forEach(div => {
            let dps = state.players.filter(x => String(x.division)===String(div));
            let scored = dps.filter(p => getNum(p.toPar) !== null);
            let minScore = scored.length > 0 ? Math.min(...scored.map(p => getNum(p.toPar))) : null;

            let players = dps.map(p => {
                const livePts = calculateLivePoints(p, dps, state.isSignature);
                const isWinner = getNum(p.toPar) !== null && getNum(p.toPar) === minScore;
                const accum = (p.history || []).reduce((a, b) => a + (getNum(b)||0), 0) + (getNum(p.toPar)||0);
                return { 
                    ...p, 
                    totalPts: (p.seasonPts || 0) + livePts,
                    totalWins: (p.wins || 0) + (isWinner ? 1 : 0),
                    totalEvents: (p.events || 0) + (getNum(p.toPar) !== null ? 1 : 0),
                    accum: accum
                };
            }).sort((a,b) => b.totalPts - a.totalPts || a.accum - b.accum);

            if(!players.length) return;
            container.innerHTML += `
                <div class="table-scroll-area">
                    <div class="div-header div-${div}">Division ${div} Season Rankings</div>
                    <table>
                        <thead><tr>
                            <th>RK</th>
                            <th style="text-align:left; padding-left:15px;">PLAYER</th>
                            <th>ACCUM</th><th>WINS</th><th>EVENTS</th><th class="pts-col">SEASON PTS</th>
                        </tr></thead>
                        <tbody>${players.map((p, i) => {
                            let rowClass = "";
                            if (i < 2 && div > 1) rowClass = "promo-row";
                            if (i >= players.length - 2 && div < 3) rowClass = "releg-row";
                            return `
                            <tr class="${rowClass}">
                                <td>${i+1}</td>
                                <td><div class="name-cell"><span class="plat-icon">${getPlatIcon(p.platform)}</span>${p.name}</div></td>
                                <td style="${getScoreStyle(p.accum)}">${p.accum === 0 ? 'E' : (p.accum > 0 ? '+'+p.accum : p.accum)}</td>
                                <td>${p.totalWins}</td>
                                <td>${p.totalEvents}</td>
                                <td class="pts-col">${p.totalPts}</td>
                            </tr>`;
                        }).join('')}</tbody>
                    </table>
                </div>`;
        });
    }
    loadData();
</script>
</body>
</html>