<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grip & Rip League Standings</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root { 
            --div1: #0047AB; --div2: #008B8B; --div3: #D2691E; --gold: #FFD700; 
            --header-grad: linear-gradient(135deg, #7C7C7C 0%, #545454 100%); 
            --red: #dc3545; --green: #28a745;
            --promo-bg: rgba(40, 167, 69, 0.1);
            --releg-bg: rgba(220, 53, 69, 0.1);
        }
        body { background-color: #f0f2f5; margin: 0; padding: 10px; font-family: 'Segoe UI', sans-serif; }
        .leaderboard-container { max-width: 1100px; margin: 0 auto; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.15); margin-bottom: 30px; }
        
        .header { background: var(--header-grad); color: white; padding: 25px; text-align: center; border-bottom: 4px solid var(--gold); }
        .header-title { font-size: 26px; font-weight: 900; text-transform: uppercase; letter-spacing: 2px; }
        
        .info-bar { background: #2d2d2d; color: #fff; padding: 15px; display: flex; justify-content: center; gap: 15px; flex-wrap: wrap; font-size: 14px; }
        .info-item { background: rgba(255,255,255,0.1); padding: 6px 12px; border-radius: 5px; border-left: 3px solid var(--gold); }
        .label { color: var(--gold); font-weight: bold; margin-right: 5px; text-transform: uppercase; font-size: 11px; }

        .section-title { background: #333; color: white; padding: 12px; font-size: 18px; font-weight: 900; text-align: center; text-transform: uppercase; }
        .div-header { color: white; padding: 10px; font-size: 16px; font-weight: bold; text-transform: uppercase; }
        .div-1 { background: var(--div1); } .div-2 { background: var(--div2); } .div-3 { background: var(--div3); }
        
        .table-wrapper { width: 100%; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 800px; }
        th { background: #f8f9fa; padding: 12px; font-size: 11px; color: #666; text-transform: uppercase; border-bottom: 2px solid #ddd; }
        td { padding: 14px 10px; text-align: center; border-bottom: 1px solid #eee; }
        
        .promo-row { background-color: var(--promo-bg) !important; border-left: 4px solid var(--green); }
        .releg-row { background-color: var(--releg-bg) !important; border-left: 4px solid var(--red); }
        .promo-text { color: var(--green); font-weight: 800; font-size: 10px; display: block; margin-top: 2px; }
        .releg-text { color: var(--red); font-weight: 800; font-size: 10px; display: block; margin-top: 2px; }

        .pts-col { font-weight: 900; color: #0047AB; font-size: 17px; background: rgba(0,71,171,0.04); }
        .sig-badge { background: var(--gold); color: #000; padding: 2px 8px; border-radius: 10px; font-size: 10px; font-weight: 900; margin-left: 8px; }
    </style>
</head>
<body>

    <div class="leaderboard-container">
        <div class="header">
            <div class="header-title">Grip & Rip League</div>
        </div>
        <div class="info-bar" id="meta-info">Syncing clubhouse data...</div>

        <div class="section-title"><i class="fa-solid fa-flag-checkered"></i> Current Tournament</div>
        <div id="current-tournament-content"></div>

        <div class="section-title" style="margin-top:20px;"><i class="fa-solid fa-award"></i> Season Standings</div>
        <div id="season-standings-content"></div>
    </div>

<script>
    const ptsMap = [100, 90, 80, 70, 60, 50, 40, 30, 20, 10];

    async function loadData() {
        try {
            const response = await fetch('GR_Backup.json?t=' + Date.now());
            const state = await response.json();
            render(state);
        } catch (e) {
            document.getElementById('meta-info').innerHTML = "Clubhouse is currently closed.";
        }
    }

    function getNum(val) {
        if (!val || val === '' || val === '-' || val === '.') return null;
        return (val.toString().toUpperCase() === 'E') ? 0 : Number(val);
    }

    function calculateLivePoints(player, divisionPlayers, isSig) {
        const score = getNum(player.toPar);
        if (score === null) return 0;

        let pointsBeforeMultiplier = 0;
        const multiplier = (isSig === true || isSig === 'true') ? 2 : 1;

        // 1. Rank
        const scoredPlayers = divisionPlayers.filter(p => getNum(p.toPar) !== null).sort((a,b) => getNum(a.toPar) - getNum(b.toPar));
        const firstTieIdx = scoredPlayers.findIndex(p => getNum(p.toPar) === score);
        pointsBeforeMultiplier += (firstTieIdx !== -1 && firstTieIdx < ptsMap.length) ? ptsMap[firstTieIdx] : 5;

        // 2. Putt Bonus
        const validPutts = divisionPlayers.map(p => getNum(p.putt)).filter(v => v !== null && v > 0);
        const minPutt = validPutts.length ? Math.min(...validPutts) : null;
        if (getNum(player.putt) !== null && getNum(player.putt) === minPutt) pointsBeforeMultiplier += 25;

        // 3. Shot Bonus
        const validHoles = divisionPlayers.map(p => getNum(p.hole)).filter(v => v !== null && v > 0);
        const maxHole = validHoles.length ? Math.max(...validHoles) : null;
        if (getNum(player.hole) !== null && getNum(player.hole) === maxHole) pointsBeforeMultiplier += 25;

        let total = pointsBeforeMultiplier * multiplier;
        total += (parseInt(player.hio) || 0) * 50;
        total += (parseInt(player.albatross) || 0) * 50;

        return total;
    }

    function render(state) {
        document.getElementById('meta-info').innerHTML = `
            <div class="info-item"><span class="label">Week</span>${state.week}</div>
            <div class="info-item"><span class="label">Venue</span>${state.venue}${state.isSignature ? '<span class="sig-badge">SIGNATURE</span>' : ''}</div>
        `;

        const currentDiv = document.getElementById('current-tournament-content');
        const seasonDiv = document.getElementById('season-standings-content');
        currentDiv.innerHTML = ''; seasonDiv.innerHTML = '';

        [1, 2, 3].forEach(divNum => {
            let dps = state.players.filter(p => Number(p.division) === divNum);
            if (dps.length === 0) return;

            // --- CURRENT ROUND ---
            let roundRows = [...dps].sort((a,b) => (getNum(a.toPar) ?? 999) - (getNum(b.toPar) ?? 999)).map((p, idx) => {
                const score = getNum(p.toPar);
                const lp = calculateLivePoints(p, dps, state.isSignature);
                return `<tr>
                    <td>${score !== null ? (idx + 1) : '-'}</td>
                    <td style="text-align:left; font-weight:700;">${p.name}</td>
                    <td style="font-weight:700; color:${score <= 0 ? 'var(--green)' : 'black'}">${score === null ? '--' : (score === 0 ? 'E' : (score > 0 ? '+'+score : score))}</td>
                    <td>${p.putt || '--'}</td><td>${p.hole || '--'}</td>
                    <td class="pts-col">${lp}</td>
                </tr>`;
            }).join('');

            currentDiv.innerHTML += `
                <div class="div-header div-${divNum}">Division ${divNum}</div>
                <div class="table-wrapper"><table>
                    <thead><tr><th>POS</th><th style="text-align:left">PLAYER</th><th>TO PAR</th><th>PUTT</th><th>SHOT</th><th class="pts-col">LIVE PTS</th></tr></thead>
                    <tbody>${roundRows}</tbody>
                </table></div>`;

            // --- SEASON STANDINGS ---
            let seasonList = dps.map(p => {
                const livePts = calculateLivePoints(p, dps, state.isSignature);
                return { p, totalPts: (Number(p.seasonPts) || 0) + livePts };
            }).sort((a,b) => b.totalPts - a.totalPts);

            let seasonRows = seasonList.map((item, idx) => {
                let rowClass = ""; let statusLabel = "";
                if (divNum < 3 && idx >= seasonList.length - 2) { rowClass = "releg-row"; statusLabel = '<span class="releg-text">RELEGATION</span>'; }
                if (divNum > 1 && idx < 2) { rowClass = "promo-row"; statusLabel = '<span class="promo-text">PROMOTION</span>'; }

                return `<tr class="${rowClass}">
                    <td>${idx + 1}</td>
                    <td style="text-align:left; font-weight:700;">${item.p.name}${statusLabel}</td>
                    <td class="pts-col">${item.totalPts}</td>
                </tr>`;
            }).join('');

            seasonDiv.innerHTML += `
                <div class="div-header div-${divNum}">Division ${divNum} Standings</div>
                <div class="table-wrapper"><table>
                    <thead><tr><th>RANK</th><th style="text-align:left">PLAYER</th><th class="pts-col">TOTAL PTS</th></tr></thead>
                    <tbody>${seasonRows}</tbody>
                </table></div>`;
        });
    }

    loadData();
</script>
</body>
</html>