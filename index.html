<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grip & Rip League Standings</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root { 
            --div1: #0047AB; --div2: #008B8B; --div3: #D2691E; --gold: #FFD700; 
            --header-grad: linear-gradient(135deg, #7C7C7C 0%, #545454 100%); 
            --info-grad: linear-gradient(135deg, #4a4a4a 0%, #2d2d2d 100%);
            --red: #dc3545; --green: #28a745;
        }
        body { background-color: #f0f2f5; margin: 10px; font-family: 'Segoe UI', sans-serif; }
        .leaderboard-container { max-width: 1000px; margin: 0 auto; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.15); margin-bottom: 20px; }
        .header { background: var(--header-grad); color: white; padding: 20px; text-align: center; border-bottom: 4px solid var(--gold); }
        .header-title { font-size: 28px; font-weight: 900; text-transform: uppercase; letter-spacing: 2px; }
        
        .info-bar { background: var(--info-grad); color: #fff; padding: 15px; display: flex; justify-content: center; gap: 20px; flex-wrap: wrap; font-size: 14px; }
        .info-item { background: rgba(255,255,255,0.1); padding: 5px 12px; border-radius: 5px; }
        .label { color: var(--gold); font-weight: bold; margin-right: 5px; text-transform: uppercase; }

        .div-header { background: #444; color: white; padding: 12px; font-size: 18px; font-weight: bold; text-transform: uppercase; text-align: center; }
        .div-1 { background: var(--div1); } .div-2 { background: var(--div2); } .div-3 { background: var(--div3); }
        
        table { width: 100%; border-collapse: collapse; font-size: 16px; }
        th { background: #f8f9fa; padding: 10px; font-size: 12px; color: #666; text-transform: uppercase; }
        td { padding: 12px 8px; text-align: center; border-bottom: 1px solid #eee; }
        
        .name-cell { display: flex; align-items: center; text-align: left; font-weight: 600; }
        .plat-icon { margin-right: 10px; width: 20px; text-align: center; }
        
        .up { color: var(--green); } .down { color: var(--red); }
        .pts-col { font-weight: 800; color: #0047AB; }
        .sig-badge { background: var(--gold); color: #000; padding: 2px 8px; border-radius: 10px; font-size: 10px; font-weight: 900; margin-left: 10px; vertical-align: middle; }
    </style>
</head>
<body>

    <div class="leaderboard-container">
        <div class="header">
            <div class="header-title">Grip & Rip Leaderboard</div>
        </div>
        <div class="info-bar" id="meta-info">Loading season data...</div>
        <div id="display-content"></div>
    </div>

<script>
    const ptsMap = [100, 90, 80, 70, 60, 50, 40, 30, 20, 10];

    async function loadData() {
        try {
            // This pulls the JSON file from the same folder on GitHub
            const response = await fetch('GR_Backup.json');
            const state = await response.json();
            render(state);
        } catch (e) {
            document.getElementById('meta-info').innerHTML = "Error loading data. Make sure GR_Backup.json is uploaded.";
        }
    }

    function getNum(val) {
        if (!val || val === '' || val === '-' || val === '.') return null;
        return (val.toString().toUpperCase() === 'E') ? 0 : Number(val);
    }

    function calculateLivePoints(player, divisionPlayers, isSig) {
        const score = getNum(player.toPar);
        if (score === null) return 0;
        const multiplier = isSig ? 2 : 1;
        const scoredPlayers = divisionPlayers.filter(p => getNum(p.toPar) !== null).sort((a,b) => getNum(a.toPar) - getNum(b.toPar));
        const firstTieIdx = scoredPlayers.findIndex(p => getNum(p.toPar) === score);
        
        let pts = (firstTieIdx !== -1 && firstTieIdx < ptsMap.length) ? (ptsMap[firstTieIdx] * multiplier) : (5 * multiplier);
        
        const validPutts = divisionPlayers.map(p => getNum(p.putt)).filter(v => v !== null && v > 0);
        const minPutt = validPutts.length ? Math.min(...validPutts) : null;
        const validHoles = divisionPlayers.map(p => getNum(p.hole)).filter(v => v !== null && v > 0);
        const maxHole = validHoles.length ? Math.max(...validHoles) : null;
        
        if (getNum(player.putt) === minPutt && minPutt !== null) pts += (25 * multiplier);
        if (getNum(player.hole) === maxHole && maxHole !== null) pts += (25 * multiplier);
        pts += (parseInt(player.hio) || 0) * 50;
        pts += (parseInt(player.albatross) || 0) * 50;
        return pts;
    }

    function render(state) {
        const meta = document.getElementById('meta-info');
        meta.innerHTML = `
            <div class="info-item"><span class="label">Season</span>${state.season}</div>
            <div class="info-item"><span class="label">Week</span>${state.week}</div>
            <div class="info-item"><span class="label">Venue</span>${state.venue} ${state.isSignature ? '<span class="sig-badge">SIGNATURE</span>' : ''}</div>
            <div class="info-item"><span class="label">Par</span>${state.par}</div>
        `;

        const container = document.getElementById('display-content');
        container.innerHTML = '';

        [1, 2, 3].forEach(divNum => {
            let dps = state.players.filter(p => String(p.division) === String(divNum));
            let scored = dps.filter(p => getNum(p.toPar) !== null);
            let minScore = scored.length > 0 ? Math.min(...scored.map(p => getNum(p.toPar))) : null;

            let list = dps.map(p => {
                const histScore = (p.history || []).reduce((s, v) => s + (Number(v) || 0), 0);
                const currScore = getNum(p.toPar);
                const livePts = calculateLivePoints(p, dps, state.isSignature);
                return { 
                    p, 
                    accum: histScore + (currScore !== null ? currScore : 0),
                    totalPts: (p.seasonPts || 0) + livePts,
                    liveWins: (p.wins || 0) + (currScore !== null && currScore === minScore ? 1 : 0),
                    liveEvents: (p.events || 0) + (currScore !== null ? 1 : 0)
                };
            }).sort((a,b) => b.totalPts - a.totalPts || a.accum - b.accum);

            if (list.length === 0) return;

            let rows = list.map((item, idx) => {
                const p = item.p;
                const movement = !p.prevRank ? '—' : (idx + 1 < p.prevRank ? '<span class="up">▲</span>' : (idx + 1 > p.prevRank ? '<span class="down">▼</span>' : '—'));
                return `<tr>
                    <td>${movement}</td>
                    <td>${idx + 1}</td>
                    <td><div class="name-cell">${getPlatIcon(p.platform)} ${p.name}</div></td>
                    <td style="color:${item.accum <= 0 ? 'var(--green)' : 'black'}">${item.accum === 0 ? 'E' : (item.accum > 0 ? '+'+item.accum : item.accum)}</td>
                    <td class="pts-col">${item.totalPts}</td>
                    <td>${item.liveWins}</td>
                    <td>${item.liveEvents}</td>
                </tr>`;
            }).join('');

            container.innerHTML += `
                <div class="div-header div-${divNum}">Division ${divNum} Standings</div>
                <table>
                    <thead><tr><th>+/-</th><th>RK</th><th style="text-align:left">Player</th><th>Accum</th><th>Pts</th><th>W</th><th>Ev</th></tr></thead>
                    <tbody>${rows}</tbody>
                </table>
            `;
        });
    }

    function getPlatIcon(p) {
        if (p === 'xbox') return '<i class="fa-brands fa-xbox" style="color:#107C10"></i>';
        if (p === 'playstation') return '<i class="fa-brands fa-playstation" style="color:#003087"></i>';
        return '<i class="fa-brands fa-steam" style="color:#171a21"></i>';
    }

    loadData();
</script>
</body>
</html>